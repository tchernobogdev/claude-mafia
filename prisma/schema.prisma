generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db?mode=wal&_journal_mode=WAL&_busy_timeout=5000"
}

model Agent {
  id             String         @id @default(cuid())
  name           String
  role           String
  specialty      String?
  systemPrompt   String         @default("")
  model          String         @default("claude-sonnet-4-5-20250929")
  providerId     String         @default("anthropic")
  parentId       String?
  posX           Float          @default(100)
  posY           Float          @default(100)
  orderIndex     Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  isDynamic      Boolean        @default(false)
  conversationId String?
  parent         Agent?         @relation("Hierarchy", fields: [parentId], references: [id])
  children       Agent[]        @relation("Hierarchy")
  agentContexts  AgentContext[]
  messages       Message[]
  incomingRels   Relationship[] @relation("ToAgent")
  outgoingRels   Relationship[] @relation("FromAgent")

  @@index([role, isDynamic])
  @@index([conversationId])
}

model Relationship {
  id          String @id @default(cuid())
  fromAgentId String
  toAgentId   String
  action      String
  cardinality String @default("1:1")
  toAgent     Agent  @relation("ToAgent", fields: [toAgentId], references: [id], onDelete: Cascade)
  fromAgent   Agent  @relation("FromAgent", fields: [fromAgentId], references: [id], onDelete: Cascade)

  @@unique([fromAgentId, toAgentId, action])
}

model Conversation {
  id               String           @id @default(cuid())
  title            String           @default("New Task")
  status           String           @default("active")
  workingDirectory String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  agentContexts    AgentContext[]
  escalations      Escalation[]
  messages         Message[]
  progress         ProjectProgress?
  testRuns         TestRun[]

  @@index([status])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  agentId        String?
  role           String
  content        String
  metadata       String?
  createdAt      DateTime     @default(now())
  agent          Agent?       @relation(fields: [agentId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, role])
  @@index([conversationId, agentId])
  @@index([conversationId, createdAt])
}

model Escalation {
  id             String       @id @default(cuid())
  conversationId String
  fromAgentId    String
  question       String
  answer         String?
  status         String       @default("pending")
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, status])
}

model AgentContext {
  id             String       @id @default(cuid())
  conversationId String
  agentId        String
  summary        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  agent          Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, agentId])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model OrgTemplate {
  id            String   @id @default(cuid())
  name          String
  agents        String
  relationships String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TestRun {
  id             String       @id @default(cuid())
  conversationId String
  agentId        String
  status         String
  startedAt      DateTime     @default(now())
  completedAt    DateTime?
  summary        String?
  testCases      TestCase[]
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model TestCase {
  id        String  @id @default(cuid())
  testRunId String
  name      String
  status    String
  error     String?
  duration  Int?
  testRun   TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)
}

model ProjectProgress {
  id              String          @id @default(cuid())
  conversationId  String          @unique
  projectName     String
  objective       String
  currentPhase    String          @default("planning")
  overallStatus   String          @default("in_progress")
  totalPhases     Int             @default(0)
  completedPhases Int             @default(0)
  startedAt       DateTime        @default(now())
  lastActiveAt    DateTime        @default(now())
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  checkpoints     Checkpoint[]
  decisions       Decision[]
  fileChanges     FileChange[]
  phases          ProgressPhase[]
  conversation    Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model ProgressPhase {
  id          String          @id @default(cuid())
  progressId  String
  name        String
  description String
  status      String          @default("pending")
  orderIndex  Int             @default(0)
  assignedTo  String?
  result      String?
  blockedBy   String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  progress    ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, status])
  @@index([progressId, orderIndex])
}

model FileChange {
  id          String          @id @default(cuid())
  progressId  String
  filePath    String
  changeType  String
  description String
  agentName   String?
  phaseId     String?
  createdAt   DateTime        @default(now())
  progress    ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, createdAt])
}

model Decision {
  id          String          @id @default(cuid())
  progressId  String
  topic       String
  question    String
  decision    String
  rationale   String?
  madeBy      String
  phaseId     String?
  revisitFlag Boolean         @default(false)
  revisitNote String?
  createdAt   DateTime        @default(now())
  progress    ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, createdAt])
  @@index([progressId, revisitFlag])
}

model Checkpoint {
  id             String          @id @default(cuid())
  progressId     String
  name           String
  description    String
  phaseSnapshot  String
  pendingTasks   String
  contextSummary String
  createdAt      DateTime        @default(now())
  progress       ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, createdAt])
}
